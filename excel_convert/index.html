<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>Excel Data Converter</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="l-wrapper">
	<header class="l-header">
		<div class="header">
			<h1>Excel Data Converter</h1>
		</div>
	</header>
	<div id="app"></div>
</div>
<script type="text/x-template" id="tmpl-app">
	<div class="l-content">
		<div class="cmn_box">
			<div class="cmn_box-ttl">
				<h2>【１】設定選択</h2>
			</div>
			<div class="cmn_box-main">
				<div class="l-select_setting">
					<div class="select_parts">
						<p class="select_parts-label">{{selected_setting_label}}</p>
						<select v-model="setting.selected" @change="onChangeSettingSelect">
							<option value="">↓選択してください</option>
							<option v-for="setting in setting.data" :key="setting.key" :value="setting.id">{{setting.name}}</option>
						</select>
					</div>
				</div>

			</div>
		</div>

		<div class="cmn_box">
			<div class="cmn_box-ttl">
				<h2>【２】TSVファイルインポート</h2>
			</div>
			<div class="cmn_box-main">
				<div class="l-input_file">
					<div class="input_type_file_parts">
						<input type="file" :disabled="setting.selected?false:true" @change="onChangeInputFile" v-if="input_file.is_show_input_parts"/>
						<div class="input_type_file_parts-info" v-if="input_file.info">
							<dl>
								<dt>ファイル名</dt>
								<dd>{{input_file.info.name}}</dd>
								<dt>最終更新日時</dt>
								<dd>{{input_file.info.lastModifiedDate}}</dd>
								<dt>ファイルサイズ</dt>
								<dd>{{input_file.info.size}} byte</dd>
								<dt>MIMEタイプ</dt>
								<dd>{{input_file.info.type}}</dd>
							</dl>
							<a href="#" @click.prevent="clearInputFile" class="input_type_file_parts-clear">TSVファイルをクリアする</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="cmn_box">
			<div class="cmn_box-ttl">
				<h2>【３】出力</h2>
			</div>
			<div class="cmn_box-main">
				<div class="l-output_file">
					<div class="textarea_parts">
						<textarea placeholder="ここに出力されます" v-html="output.txt"></textarea>
					</div>
				</div>
				<div class="l-dl_btn" v-if="output.dl_link && current_setting.output && current_setting.output.type === 'json'">
					<div class="dl_btn">
						<a :href="output.dl_link" :download="current_setting.output.name+'.json'">
							ダウンロード
							<span class="dl_btn-filename">{{current_setting.output.name}}.json</span>
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</script>
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="./settings.js"></script>
<script type="text/javascript">
	(function(){
		new Vue({
			el:'#app',
			template:'#tmpl-app',
			data:{
				setting:{
					selected:'',
					data:'settings' in window ?settings:[],
				},
				input_file:{
					is_show_input_parts:true,
					info:null,
					reader:null
				},
				output:{
					obj:null,
					txt:'',
					dl_link:''
				}
			},
			computed:{
				selected_setting_label:function(){
					var that = this;
					var ret = '↓選択してください';
					this.setting.data.forEach(function(setting){
						if(setting.id === that.setting.selected){
							ret = setting.name;
						}
					});
					return ret;
				},
				current_setting:function(){
					var that = this;
					var ret = {};
					this.setting.data.forEach(function(setting){
						if(setting.id === that.setting.selected){
							ret = setting;
						}
					});
					return ret;
				}
			},
			created:function(){
				this.input_file.reader = new FileReader();
				this.input_file.reader.addEventListener('load', this.onFileLoad, false);
				console.log(this.setting.data);
			},
			methods:{
				onChangeSettingSelect:function(){
					this._clearData('input_file');
					console.log('setting.selected : '+this.setting.selected);
				},
				onChangeInputFile:function(e){
					var target = e.target;
					var files = target.files;
					if(files.length){
						this.input_file.info = files[0];
						var charset = this.current_setting.input.charset || 'UTF-8';
						this.input_file.reader.readAsText(files[0],charset);
					}
				},
				/**
				 * 入力ファイルをクリア
				 */
				clearInputFile:function(){
					this._clearData('input_file');
				},
				onFileLoad:function(){
					var that = this;
					var input_file_text = this.input_file.reader.result;
					// TODO: ここ、なんとかわかりやすく書けないか？関数に関数を渡せるが、それだと可読性が…
					this.output.obj = (function(input_file_text,setting){
						var tmp = that._makeTwoDimensionalArrayFromTsv(input_file_text, {
							quote: (setting.quote || '"'),
							linedelim: (setting.linedelim || '999999'),
						});
						return that._makeAssociativeArrayObjectFromArray(tmp,{
							keys:(setting.input.keys || []),
							enable_line_from:(setting.input.enable_line_from || 3)
						});
					})(input_file_text,this.current_setting);

					this.output.txt = JSON.stringify({date:this.input_file.info.lastModifiedDate,list:this.output.obj});
					this._setDlBtn();
				},
				/**
				 * tsvテキストから二次元配列化
				 * @param {String} txt
				 * @param {Object} op オプション
				 * @param {String} op.quote 文字列を囲み
				 * @param {String} op.linedelim 行のデリミタ
				 * @returns {Array}
				 */
				_makeTwoDimensionalArrayFromTsv:function(txt,op){
					if(!op || !op.quote|| !op.linedelim){
						console.log('TSVを二次元配列にするための情報が不足しています。');
						return;
					}
					var ret_ary = [];
					var re_quote = new RegExp('^'+op.quote+'([\\s\\S]+)'+op.quote+'$','m');
					var lines = (function(tsv){
						return tsv.split(op.linedelim);
					})(txt,op);
					lines.forEach(function(line,index){
						if(!(line.replace(/[\n\r\t]/g,''))){
							// 改行、タブをトルツメして空文字になる行は追加しない
							return;
						}
						var items = line.split('\t');
						items.forEach(function(item,item_index){
							if(item && item.match(re_quote)){
								items[item_index] = item.replace(re_quote,function(whole,s1){
									return s1;
								});
							}
						});
						ret_ary.push(items);
					});
					return ret_ary;
				},
				/**
				 * 二次元配列から連想配列化
				 * @param {String} ary 加工元の二次元配列
				 * @param {Object} op オプション
				 * @param {Object.<String, Array>} op.keys エクセルの見出し文字列とkey名の組み合わせ、またそれぞれの追加処理等
				 * @param {Object.<String, Number>} op.enable_line_from 処理開始行
				 * @returns {Object}
				 */
				_makeAssociativeArrayObjectFromArray:function(ary,op){
					var ret = [];
					var _keys = [];
					var _tmp_obj = {};
					var _key_name_form_excel_name = {};
					var _key_settings_by_name = {};
					op.keys.forEach(function(key_setting){
						_key_name_form_excel_name[key_setting.excel_name] = key_setting.name;
						_key_settings_by_name[key_setting.name] = key_setting;
					});
					ary.forEach(function(line,line_index){
						if(line_index >= op.enable_line_from-1){
							_tmp_obj = {};
						}
						line.forEach(function(item,item_index){
							if(line_index === 0){
								_keys.push((_key_name_form_excel_name[item]?_key_name_form_excel_name[item]:''));
							}else if(line_index >= op.enable_line_from-1){
								// item_index に key 名をもっていたら追加
								if(_keys[item_index]){
									// 改行コードを<br>にする
									if(_key_settings_by_name[_keys[item_index]].is_nl2br){
										item = item.replace(/\n/gm,'<br>');
									}
									// 〇 を true / 〇以外を false に変換
									if(_key_settings_by_name[_keys[item_index]].is_bool){
										item = (item === '〇');
									}
									// func 適用
									if(_key_settings_by_name[_keys[item_index]].func && typeof _key_settings_by_name[_keys[item_index]].func === "function"){
										item = _key_settings_by_name[_keys[item_index]].func(item);
									}
									_tmp_obj[_keys[item_index]] = item;
								}
							}
						});
						if(line_index >= op.enable_line_from-1 && Object.keys(_tmp_obj).length){
							ret.push(_tmp_obj);
						}
					});
					return ret;
				},
				/**
				 * 指定の工程以降のデータを初期化
				 * @param {String} step setting,input_file,output のいずれか、未指定の場合は setting
				 */
				_clearData:function(step){
					var that = this;
					if(!step){
						step = 'setting';
					}
					var steps = ['setting','input_file','output'];
					var tgt_steps = [];
					['setting','input_file','output'].forEach(function(tgt){
						if(tgt === step || tgt_steps.length){
							tgt_steps.push(tgt);
						}
					});
					if(!tgt_steps.length){
						console.log('_clearData のパラメータ'+step+'が不適切です。');
					}
					tgt_steps.forEach(function(tgt){
						if(tgt==='setting'){
							that.setting.selected = '';
						}else if(tgt==='input_file'){
							if(that.input_file.info){
								that.input_file.info = null;
								that.input_file.is_show_input_parts = false;
								setTimeout(function(){
									that.input_file.is_show_input_parts = true;
								}, 500);
							}
						}else if(tgt==='output'){
							that.output.obj = null;
							that.output.txt= '';
							that.output.dl_link = '';
						}
					});

				},
				_setDlBtn:function(){
					var blob = new Blob([ this.output.txt ], { "type" : "application/json" });
					window.URL = window.URL || window.webkitURL;
					this.output.dl_link = window.URL.createObjectURL(blob);
				}
			}
		});
	})();
</script>
</body>
</html>